var CreatorCardPolling;(function(n){let t;(function(n){n[n.NEW=0]="NEW";n[n.PROCESSING=1]="PROCESSING";n[n.COMPLETE=2]="COMPLETE";n[n.RETRY=3]="RETRY";n[n.CANCEL=4]="CANCEL"})(t||(t={}));class i{constructor(n){this.config=n;this.xhr=sj_gx();this.endpoint="wpt/crpol";this.customizationEndpoint="wpt/crpolcust";this.retryCount=0;this.isCustomization=!1;this.currentStatus=t.NEW;this.lastModelResponseText="";this.request=null;this.lastResponse=null}sendRequest(n){var i;if(n&&this.currentStatus!=t.PROCESSING){(this.currentStatus==t.COMPLETE||this.currentStatus==t.NEW)&&(this.retryCount=0,this.isCustomization=!1);this.request=n;const{isCustomized:u,configForPrompt:f,configForCache:r,modelName:e,llmResponseModelName:o}=n,s=e!==o;this.isCustomization=!!u&&(!!f||!!(r===null||r===void 0?void 0:r.length)||s);this.isCustomization&&(this.request.llmResponse=this.lastModelResponseText);n.customizationMode&&(this.customizationMode=n.customizationMode);this.currentStatus=t.PROCESSING;const h=`${this.config.enablePollingAjaxFix?this.getBaseUrl():""}${this.isCustomization?this.customizationEndpoint:this.endpoint}?query=${n.query}${(i=this.config.queryParams)!==null&&i!==void 0?i:""}`;try{this.xhr.open("POST",h,!0);this.xhr.timeout=this.config.timeoutMs;this.xhr.setRequestHeader("Content-type","application/json");this.xhr.onreadystatechange=()=>this.handleResponse(this.xhr);this.xhr.onerror=()=>{this.handleError(()=>this.sendRequest(this.request),"XHROnError")};this.xhr.send(JSON.stringify(this.request))}catch(c){this.handleError(()=>this.sendRequest(this.request),c)}}}cancel(){var i,n,r;clearTimeout(this.retryTimeoutId);(i=this.xhr)===null||i===void 0?void 0:i.abort();this.currentStatus=t.CANCEL;this.retryCount=0;(r=(n=this.config.observer)===null||n===void 0?void 0:n.onCancel)===null||r===void 0?void 0:r.call(n)}getLastResponse(){return this.lastResponse}setLastModelResponseText(n){try{const t=JSON.parse(n);t.text&&this.customizationMode!=="Inline"&&(this.lastModelResponseText=t.text)}catch(t){}}handleResponse(n){if(n.readyState===XMLHttpRequest.DONE){if(n.status!==200)return this.handleError(()=>this.sendRequest(this.request),n.statusText);this.currentStatus=t.COMPLETE;this.getPollingResponse(n.responseText,()=>this.sendRequest(this.request))}}getPollingResponse(n,i){var r,u;if(this.currentStatus!=t.CANCEL)try{const f=JSON.parse(n);f.isCustomization=this.isCustomization;((r=f===null||f===void 0?void 0:f.metaInfoDic)===null||r===void 0?void 0:r.ErrorType)==="ContentFilter"?(this.retryCount=this.config.maxRetryCount,this.handleError(i,this.config.locStrings.WPTCreatorContentFilterErrorMessage)):(this.isCustomization||f.modelResponse)&&(!this.isCustomization||f.answerKey)?(this.retryCount=0,this.currentStatus==t.COMPLETE&&(f.modelResponse&&(this.setLastModelResponseText(f.modelResponse),this.lastResponse=f),(u=this.config.observer)===null||u===void 0?void 0:u.onComplete(f))):this.handleError(i,this.config.locStrings.CreatorNoResponseErrorText)}catch(f){this.handleError(i,"Invalid response")}}handleError(n,i){var r;this.currentStatus!=t.CANCEL&&(this.currentStatus=t.RETRY,this.retryCount<this.config.maxRetryCount?(this.retryCount++,this.retryTimeoutId=setTimeout(n,this.config.retryIntervalMs)):(this.currentStatus=t.COMPLETE,(r=this.config.observer)===null||r===void 0?void 0:r.onError(i),Log.Log("CreatorCardPollingRetryFailed","CreatorCard","Polling",!1,i)))}getBaseUrl(){const{protocol:n,host:t}=window.location;return`${n}//${t}/`}}n.CreatorCardPolling=i})(CreatorCardPolling||(CreatorCardPolling={}))